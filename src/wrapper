#!/usr/bin/env bash

# Normalize SNAP path for Fedora and other distros
SNAP=$(echo "$SNAP" | sed -e 's|/var/lib/snapd||g')

# Detect host architecture and set WINEARCH
case "$SNAP_ARCH" in
  amd64)
    export WINEARCH="win64"
    ;;
  i386)
    export WINEARCH="win32"
    ;;
  *)
    echo "Unsupported host architecture: $SNAP_ARCH" >&2
    exit 1
    ;;
esac

# Set Wine prefix and DLL overrides
export WINEPREFIX="$SNAP_USER_COMMON/.wine"
export WINEDLLOVERRIDES="mscoree,mshtml="

# Unpack .NET prefix on first run and initialize prefix
if [ ! -d "$WINEPREFIX/drive_c" ]; then
  mkdir -p "$WINEPREFIX"
  yad --width=300 --center --title="Winbox Snap" \
      --text="Идёт начальная настройка среды Wine...\nПожалуйста, подождите." \
      --no-buttons --undecorated --on-top &
  YAD_PID=$!
  tar -xJf "$SNAP/usr/libexec/winbox/prefix/dotnetpfx.tar.xz" -C "$WINEPREFIX"
  # Initialize Wine prefix (registry, drives, etc.)
  wine64 wineboot -r
  kill "$YAD_PID"
fi

# Ensure Winbox executable is in the prefix (from SNAP prefix)
WINBOX_EXE="$WINEPREFIX/drive_c/Program Files/Winbox/winbox.exe"
if [ ! -f "$WINBOX_EXE" ]; then
  mkdir -p "$(dirname "$WINBOX_EXE")"
  cp "$SNAP/usr/libexec/winbox/winbox64.exe" "$WINBOX_EXE"
fi

if [ "$1" == "winecfg" ]; then
  wine64 winecfg
elif [ "$1" == "winetricks" ] ; then
  winetricks
else
  ${SNAP}/bin/sommelier "$WINBOX_EXE"
fi
